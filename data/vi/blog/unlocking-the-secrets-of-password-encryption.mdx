---
title: 'Khám Phá Bí Mật của Mã Hóa Mật Khẩu'
date: '2024-07-18'
tags: ['security', 'issue', 'PHP']
draft: false
summary: 'Làm thế nào để tìm account nào đang sử dụng password mặc định trong hệ thống'
images: ['/static/images/unlocking-the-secrets-of-password-encryption.jpg']
authors: ['default']
---

import Twemoji from './Twemoji.tsx'
import UnsplashPhotoInfo from './UnsplashPhotoInfo.tsx'

![thumbnail-image](/static/images/blogs/unlocking-the-secrets-of-password-encryption.jpg)

<UnsplashPhotoInfo
  photoURL="https://unsplash.com/photos/matrix-movie-still-iar-afB0QQw"
  author="Markus Spiske"
/>

## Dẫn nhập

Hôm nay mình nhận được 1 task như thế này

> Tìm account nào đang sử dụng password mặc định trong hệ thống (Hệ thống sử dụng Laravel 5.8)

Ban đầu mình nghĩ là chỉ cần lấy password mặc định hash ra và vào database query account nào đang sử dụng password nào giống với hash thì account đó đang dùng mật khẩu mặc định.
Nhưng không, khi thực hiện thì kết quả query của mình là **0 record**

Cùng mình tìm hiểu nguyên nhân trong blog này nhé.

### 1. Tại sao ta cần phải mã hóa mật khẩu?

Mã hóa mật khẩu là một khái niệm quen thuộc đối với mọi lập trình viên. Đây là một bước quan trọng để đảm bảo thông tin người dùng được bảo vệ, ngay cả khi cơ sở dữ liệu của chúng ta bị xâm phạm. Đã có nhiều trường hợp ứng dụng web bị rò rỉ thông tin người dùng, và điều này càng trở nên nguy hiểm hơn nếu mật khẩu không được mã hóa cẩn thận. Nhiều người sử dụng cùng một mật khẩu cho hầu hết các tài khoản của họ, và khi một mật khẩu bị lộ, tất cả các tài khoản khác đều đối mặt với nguy cơ bị đánh cắp. Vì vậy, chúng ta không bao giờ nên lưu trữ mật khẩu dưới dạng văn bản thuần túy.

Một trong những phương pháp phổ biến nhất để giải quyết vấn đề này là sử dụng kỹ thuật băm mật khẩu.

### 2. Cơ bản về băm mật khẩu

#### Hashing

Băm mật khẩu là một phương pháp phổ biến trong việc bảo vệ mật khẩu. Hàm băm là hàm một chiều, biến đổi mật khẩu ban đầu thành một chuỗi mã hóa mà không thể giải mã ngược lại. Mỗi giá trị băm duy nhất tương ứng với một mật khẩu cụ thể. Chúng ta lưu trữ giá trị băm này vào cơ sở dữ liệu. Khi người dùng đăng nhập, hệ thống sẽ băm mật khẩu đầu vào của họ và so sánh giá trị băm này với giá trị đã lưu trong cơ sở dữ liệu để xác thực.

Ví dụ:
"Tupt.dev" sau khi băm bằng thuật toán md5 sẽ cho kết quả như sau: "c229312e9bc2d88dd9365c9dc8b04cbb".

Với công nghệ máy tính hiện nay, việc giải mã hàm băm là điều không thể. Tuy nhiên, nếu không cẩn thận, kẻ tấn công vẫn có thể lấy được mật khẩu nếu hắn ta có giá trị băm. Hai phương thức tấn công phổ biến là:

- Tấn công bằng rainbow table (sử dụng bảng từ điển mật khẩu được tính toán từ trước).
- Tấn công brute force (thử mọi khả năng có thể).

Để giải quyết vấn đề này, chúng ta cần tìm hiểu về Salting và Stretching.

#### Salting

Như đã đề cập ở trên, việc băm mật khẩu đơn thuần là không đủ để đảm bảo an toàn trước các cuộc tấn công tính toán trước. Để xử lý vấn đề này, ta sử dụng Salt. Salting là quá trình thêm một đoạn dữ liệu ngẫu nhiên vào mật khẩu ban đầu trước khi băm.

Salting tuy đơn giản nhưng vô cùng hiệu quả. Nó tăng độ phức tạp của mật khẩu lên rất nhiều, do đó mật khẩu ban đầu trở nên dài hơn và phức tạp hơn. Bằng cách thêm salt, ta làm cho các cuộc tấn công tính toán trước trở nên vô dụng. Mỗi tài khoản người dùng sẽ được tạo một dãy salt ngẫu nhiên duy nhất khi đăng ký. **Hai tài khoản có cùng mật khẩu cũng sẽ không có cùng giá trị băm trả về nhờ vào salt**. Vì salting chỉ nhằm mục đích ngăn chặn các cuộc tấn công tính toán trước, nên không cần thiết phải tạo ra một hệ thống lưu trữ riêng cho salt. Thông thường, ta lưu salt trực tiếp trong cùng bảng với giá trị băm của mật khẩu.

#### Stretching

Bên cạnh tấn công bằng rainbow table, brute force cũng là một phương thức tấn công phổ biến. Nếu quá trình tính toán không quá phức tạp, kẻ tấn công có thể nhanh chóng thử mọi khả năng để tìm ra mật khẩu của người dùng. Để chống lại loại tấn công này, chúng ta sử dụng phương pháp stretching.

Stretching làm tăng độ phức tạp của thuật toán băm, khiến việc brute force trở nên khó khăn hơn nhiều. Để đạt được điều này, quá trình băm sẽ được lặp lại hàng ngàn lần. Mặc dù điều này khiến quá trình xác thực của người dùng mất thêm chút thời gian, nhưng nó sẽ làm kẻ tấn công tốn nhiều thời gian hơn rất nhiều để tìm ra mật khẩu. Với một mật khẩu được bảo vệ tốt, việc brute force để tìm ra chúng trở nên gần như không thể.

### 3. Bcrypt

Dãy hashing bcrypt thường được trình bày theo dạng sau:

```css
$[algorithm]$[cost]$[22 characters salt][31 characters hash]
```

**Cấu trúc**:

- **algorithm**: Thuật toán băm được sử dụng. Trong trường hợp này là `$2y$`, đại diện cho thuật toán bcrypt phiên bản 2.
- **cost**: Chi phí tính toán, được biểu thị dưới dạng số nguyên dương. Giá trị này quyết định số vòng lặp của hàm băm Blowfish trong quá trình tạo hash. Giá trị càng cao, quá trình băm càng chậm nhưng cũng càng an toàn hơn.
- **salt**: Chuỗi salt ngẫu nhiên 16 byte (128 bit), được mã hóa base64 thành 22 ký tự. Mục đích của salt là tăng cường độ bảo mật bằng cách khiến cho việc tạo bảng rainbow table trở nên khó khăn hơn.
- **hash**: Mã băm thực tế của mật khẩu, được tạo ra bằng cách kết hợp mật khẩu với salt và sử dụng thuật toán băm Blowfish. Mã băm này có độ dài 24 byte (192 bit) và được mã hóa base64 thành 31 ký tự.

**Ví dụ**:
Dãy hash `$2y$10$RT2Pnlx7aaG2EDHy8SgdIunndkeiLB.kUTzSdVoKgL2x/TEr1tkZG` có thể được phân tích như sau:

- Thuật toán: Bcrypt phiên bản 2 ($2y$)
- Chi phí: 1024 vòng lặp (=2^10)
- salt: `RT2Pnlx7aaG2EDHy8SgdIu` (mã hóa base64 từ chuỗi salt ngẫu nhiên 16 byte)
- Mã băm: `nndkeiLB.kUTzSdVoKgL2x/TEr1tkZG` (mã hóa base64 từ mã băm 24 byte)

**Ý nghĩa**:

Dãy hash này cho biết mật khẩu đã được băm sử dụng thuật toán bcrypt phiên bản 2 với 1024 vòng lặp. Salt ngẫu nhiên `RT2Pnlx7aaG2EDHy8SgdIu` đã được sử dụng để tăng cường độ bảo mật. Mã băm thực tế của mật khẩu là `nndkeiLB.kUTzSdVoKgL2x/TEr1tkZG`.

**Lưu ý**:

- Dãy hash bcrypt không thể được giải mã để lấy lại mật khẩu gốc.
- Chi phí băm cao hơn dẫn đến thời gian tạo hash lâu hơn nhưng mang lại độ bảo mật tốt hơn.
- salt ngẫu nhiên đóng vai trò quan trọng trong việc chống lại các tấn công rainbow table

### 4. Cách giải quyết bài toán trên

Mình đã viết 1 script với kịch bản như sau

1. Kết nối database, query tất cả users
2. Lặp qua từng user, check mật khẩu mặc định với password hash bằng hàm `password_verify`
   => Nếu `true` thì là user đó dùng password mặc định.

Dưới đây là code sample

```php
<?php
// Kết nối database
$servername = "localhost";
$username = "your_username";
$password = "your_password";
$dbname = "your_database";

$conn = mysqli_connect($servername, $username, $password, $dbname);

if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

// Khai báo biến mật khẩu mặc định
$password_default = 'tupt.dev';

// Viết truy vấn SQL để lấy tên người dùng và mật khẩu
$sql = "SELECT name, password FROM users";
$result = mysqli_query($conn, $sql);

if (mysqli_num_rows($result) > 0) {
    // Lặp qua kết quả tìm kiếm
    while($row = mysqli_fetch_assoc($result)) {
        $username = $row["name"];
        $hashed_password = $row["password"];

        // Sử dụng hàm password_verify để kiểm tra mật khẩu
        if (password_verify($password_default, $hashed_password)) {
            echo "Người dùng: " . $username . "<br>";
        }
    }
} else {
    echo "Không có ai dùng mật khẩu mặc định";
}
mysqli_close($conn);
?>
```

## Kết bài

Qua bài này chúng ta đã khám phá sâu hơn về việc mã hóa mật khẩu, các loại tấn công phổ biến và cách chống lại chúng bằng cách sử dụng salt và stretching.

Bên cạnh đó, chúng ta đã tìm hiểu về hàm băm bcrypt và cách các khái niệm này được áp dụng trong thực tế.

Happy coding <Twemoji emoji="clinking-beer-mugs" />
